<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Transit & Density</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script>
if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
  || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) window.location="images.html";
</script>
<link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Merriweather+Sans:400,300,700' rel='stylesheet' type='text/css'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />
<style>
  body {
    margin:0;
    padding:0;
    -webkit-font-smoothing: antialiased;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.004);
    background-color: #e6e1df;
  }
  .map {
    width:100%;
    height: 600px;
    margin-top: 10px;
    margin-bottom: 50px;
  }
  .main {
    /*height: 100px;*/
  }
  .col-md-8 {
    background-color: #FFFFFF;
    padding-right: 0px;
    padding-left: 0px;
    margin-top: 20px;
    box-shadow: 0 0 12px 1px rgba(87,87,87,.2);
  }
  .mapContainer {
    padding-right: 50px;
    padding-left: 50px;
    font-family: 'Merriweather', serif;
    font-weight: 300;
    font-size: 1.5em;
    /*text-align: center;*/
  }
  .header {
    text-align: center;
    /*font-family: 'Merriweather', serif;*/
    font-family: 'Open Sans', sans-serif;
    font-weight: 300;
  }
  #headertext{
    font-size: .8em;
    width:90%;
    text-align: justify;
    margin-top:15px;
    margin-bottom:60px;
  }
  #loadtext {
    font-family: 'Merriweather', serif;
    font-weight: 300;
    font-size: 18px;
    line-height: 1.5;
    letter-spacing: -0.004em;
    color: rgba(0,0,0,0.8);
    text-align: center;
    position: fixed;
    width: 100%;
    top: 68%;
    z-index: 1000;
  }
  .map-legend ul {
    list-style: none;
    padding-left: 0;
    font-family: 'Merriweather', serif;
    font-weight: 300;
    }
  .map-legend .swatch {
    width:20px;
    height:20px;
    float:left;
    margin-right:10px;
    }
  .leaflet-popup-close-button {
    display: none;
    }
  .leaflet-popup-content-wrapper {
    pointer-events: none;
    font-family: 'Merriweather', serif;
    font-weight: 300;
    }
  .leaflet-container {
    font-family: 'Merriweather', serif;
    font-weight: 300;
  }
  #ankrom-head{
    margin-bottom: 40px;
  }
  #logo-head{
    background: radial-gradient(50% 50%, rgb(199, 189, 184), rgb(160, 144, 136));
    width: 100%;
    height: 80px;
    margin: 0;
    padding: 0;
    text-align: center;
    font-family: 'Open Sans', sans-serif;
    font-size: 20.5px;
    font-weight: 300;
    font-style: normal;
    color: white;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  #logo-head a{
    font-family: 'Open Sans', sans-serif;
    font-size: 20.5px;
    font-weight: 300;
    font-style: normal;
    color: white;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
</style>
</head>
<body>
<div id="mainContainer">
<div id="ankrom-head">
  <div id="logo-head">
    <a href="http://www.ankrommoisan.com" target="_blank"><img src="img/logo.png" style="float: left; margin-top: 17px; margin-left: 50px;"></a>
    <p style="padding-top: 25px;padding-right:110px">
      <span>Ankrom Moisan Architects&nbsp&nbsp</span><span style="color:rgb(80,80,80);">/</span><span> Mapping and Data Analysis</span>
    </p>
  </div>
  <div id="black-head" style="background-color: black; width: 100%; height: 20px; margin-top: 1px;"></div>
</div>
<div class="col-md-2 main"></div>
<div class="col-md-8 main" id="centerCol">
  <div class="header">
    <nav class="navbar navbar-default" style="margin-bottom:40px;">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="./index.html">Maps</a></li>
            <li><a href="./method.html" target="_blank">Methodology</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <span style="font-size:3.5em;">Density and Transit</span><br /><span style="font-size:2em">Studying relationships</span><br /><br /><br /><hr>
    <p style="text-align:center;font-size:.75em;width:80%;margin-left:auto;margin-right:auto;margin-bottom:50px;">
      This site is intended to provide a public outlet for in-progress research that Ankrom Moisan Architects is conducting. All of the data presented here is provided in a spirit of sharing ideas about the development of cities. It is intended for general interest usage and should not be used as a basis for financial decisions.
    </p>
    <br />
  </div>
  <div class="mapContainer">
    <div id="headertext" style="width:80%; margin-left:auto; margin-right:auto;">
      <span style="font-size:25px;">Portland has one of the nations best public transit systems.</span>
      <p style="margin-top: 15px; color: #777777">
        It also continues to densify as it grows and pushes against it's Urban Growth Boundary.
        One challenge of that growth is knowing which areas may benefit most from the increased density.<br /><br /> Sites where transit access is abundant are naturally suited
        to growing denser, and many already have, but some may have been overlooked. These sites present an opportunity for higher density residential development.
        This study investigates if there are sites in Portland where transit is plentiful but housing density is still sparse.
      </p>
    </div>
    <hr><br />

    <span>Housing Density</span>
    <p style="font-size: .65em;width:90%; text-align: justify;margin-top:15px;">
      First we want to look at the density of housing in Portland. The 2010 US Census gives us a
      measure that we can convert to dwelling units per acre. There is a huge variability here, and
      the map is scaled to highlight the lower end of it.
    </p>
    <div class="map" id='densityMap'></div>
    <span>Transit Access</span>
    <p style="font-size: .65em;width:90%; text-align: justify;margin-top:15px;">
      Next we want to look at how accessible public transit is to each block. All of Portland's
      transit stops are mapped and their catchment area is projected over the blocks. The overlapping area
      is added up and divided by the size of the block to get a score,
      representing the amount of transit available a short distance from any point on the block.
      Again, very high variability led us to truncate the scale to better represent important differences.
    </p>
    <div class="map" id='transitMap'></div>
    <span>High transit access, but low density</span>
    <p style="font-size: .65em;width:90%; text-align: justify;margin-top:15px;">
      Finally, the value we are most intersted in, degree of housing under-utilization. For this we simply
      take the transit access score and divide it by the housing density. This gives higher values to sites
      with great transit access but very low housing density. Many of these have obvious potential for higher
      utilization. Some sites with high FAR, such as in the Central Business District, show under utilization
      however keep in mind that this is measuring specifically <em>housing</em> density. Even though these
      are dense sites, they do not posses a high number of housing units per acre.
    </p>
    <div class="map" id='finalMap'></div>
  </div>
</div>
<div class="col-md-2 main"></div>
</div>
<script>
$('#discBtn').on('click',function(){
  alert('');
})
L.mapbox.accessToken = 'pk.eyJ1IjoicnlhbnRtIiwiYSI6ImNpaDgycjExZzB0NDR1MWtpbWdkeDhxbmIifQ.AamjhGik8yPxK5V71kzHdw';
  var densityMap = L.mapbox.map('densityMap', 'mapbox.light').setView([45.5200, -122.6819], 13);
  var transitMap = L.mapbox.map('transitMap', 'mapbox.light').setView([45.5200, -122.6819], 13);
  var finalMap = L.mapbox.map('finalMap', 'mapbox.light').setView([45.5200, -122.6819], 13);
  var popup = new L.Popup({ autoPan: false });

  var densityLayer = L.geoJson(false, {
    style: getStyleDensity,
    //onEachFeature: onEachFeature
  }).addTo(densityMap);

  var transitLayer = L.geoJson(false, {
    style: getStyleTransit,
    //onEachFeature: onEachFeature
  }).addTo(transitMap);

  var finalLayer = L.geoJson(false, {
    style: getStyleFinal,
    onEachFeature: onEachFeature
  }).addTo(finalMap);

  $.get('https://s3-us-west-2.amazonaws.com/s3arch-dev/minifiedData.json', function(raw){
    var data = JSON.parse(raw);
    for(var i=0;i<data.features.length;i++){
      var block = data.features[i].properties;
      if(block.HOUSE_DENSITY < 0.1){
        block.NEW_SCORE = block.TRANSIT_SCORE_IMP;
      }
    }

    densityLayer.addData(data);
    transitLayer.addData(data);
    finalLayer.addData(data);
  });

  function getStyleDensity(feature) {
    return {
      weight: 1,
      opacity: 0.1,
      color: 'black',
      fillOpacity: 0.7,
      fillColor: getColorDensity(feature.properties.HOUSE_DENSITY)
    };
  }
  function getColorDensity(d) {
    return d > 24.5 ? '#084594' :
      d > 21  ? '#2171b5' :
      d > 17.5  ? '#4292c6' :
      d > 14  ? '#6baed6' :
      d > 10.5   ? '#9ecae1' :
      d > 7   ? '#c6dbef' :
      d > 3.5   ? '#deebf7' :
      '#f7fbff';
  }
  densityMap.legendControl.addLegend(getLegendDensityHTML());
  function getLegendDensityHTML() {
    var grades = [0, 3.5, 7, 10.5, 14, 17.5, 21, 24.5],
    labels = [],
    from, to;

    for (var i = 0; i < grades.length; i++) {
      from = grades[i];
      to = grades[i + 1];

      labels.push(
        '<li><span class="swatch" style="background:' + getColorDensity(from + 1) + '"></span> ' +
        from + (to ? '&ndash;' + to : '+')) + '</li>';
    }

    return '<span>Housing Density (DU/Acre)</span><ul>' + labels.join('') + '</ul>';
  }

  function getStyleTransit(feature) {
    return {
      weight: 1,
      opacity: 0.1,
      color: 'black',
      fillOpacity: 0.7,
      fillColor: getColorTransit(feature.properties.TRANSIT_SCORE_IMP)
    };
  }
  function getColorTransit(d) {
    return d > 28 ? '#084594' :
      d > 24  ? '#2171b5' :
      d > 20  ? '#4292c6' :
      d > 16  ? '#6baed6' :
      d > 12   ? '#9ecae1' :
      d > 8   ? '#c6dbef' :
      d > 4   ? '#deebf7' :
      '#f7fbff';
  }
  transitMap.legendControl.addLegend(getLegendTransitHTML());
  function getLegendTransitHTML() {
    var grades = [0, 4, 8, 12, 16, 20, 24, 28],
    labels = [],
    from, to;

    for (var i = 0; i < grades.length; i++) {
      from = grades[i];
      to = grades[i + 1];

      labels.push(
        '<li><span class="swatch" style="background:' + getColorTransit(from + 1) + '"></span> ' +
        from + (to ? '&ndash;' + to : '+')) + '</li>';
    }

    return '<span>Transit Access Score<br />(Higher is better)</span><ul>' + labels.join('') + '</ul>';
  }

  function getStyleFinal(feature) {
    return {
      weight: 1,
      opacity: 0.1,
      color: 'black',
      fillOpacity: 0.7,
      fillColor: getColorFinal(feature.properties.NEW_SCORE)
    };
  }
  function getColorFinal(d) {
    return d > 42 ? '#084594' :
      d > 36  ? '#2171b5' :
      d > 30  ? '#4292c6' :
      d > 24  ? '#6baed6' :
      d > 18   ? '#9ecae1' :
      d > 12   ? '#c6dbef' :
      d > 6   ? '#deebf7' :
      '#f7fbff';
  }
  finalMap.legendControl.addLegend(getLegendFinalHTML());
  function getLegendFinalHTML() {
    var grades = [0, 6, 12, 18, 24, 30, 36, 42],
    labels = [],
    from, to;

    for (var i = 0; i < grades.length; i++) {
      from = grades[i];
      to = grades[i + 1];

      labels.push(
        '<li><span class="swatch" style="background:' + getColorFinal(from + 1) + '"></span> ' +
        from + (to ? '&ndash;' + to : '+')) + '</li>';
    }

    return '<span>Blocks with high transit<br /> but low housing density</span><ul>' + labels.join('') + '</ul>';
  }

function onEachFeature(feature, layer) {
    layer.on({
        mousemove: mousemove,
        mouseout: mouseout,
        click: zoomToFeature
    });
}

var closeTooltip;

function mousemove(e) {
    var layer = e.target;

    popup.setLatLng(e.latlng);
    popup.setContent('<div class="marker-title">' + layer.feature.properties.NAME10 + '</div>' +
        Math.round((layer.feature.properties.HOUSE_DENSITY)* 100)/100 + ' DU/Acre<br />' + Math.round(layer.feature.properties.TRANSIT_SCORE_IMP) +
        ' Transit Score<br />' + Math.round((layer.feature.properties.NEW_SCORE)*100)/100 + ' Under-utilization Score');

    if (!popup._map) popup.openOn(finalMap);
    window.clearTimeout(closeTooltip);

    //highlight feature
    layer.setStyle({
        weight: 3,
        opacity: 0.3,
        fillOpacity: 0.9
    });

    if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }
}

function mouseout(e) {
    layer = e.target;
    layer.setStyle({
        weight: 1,
        opacity: 0.1,
        fillOpacity: 0.7
    });
    closeTooltip = window.setTimeout(function() {
        finalMap.closePopup();
    }, 100);
}

function zoomToFeature(e) {
    finalMap.fitBounds(e.target.getBounds());
}
</script>
</body>
</html>
